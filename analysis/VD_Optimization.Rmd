---
title: "Variety Development Process Optimization"
author: "Wolfemd, LucianoRogerio"
date: "2021-09-16"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

  We are simulating the expected genetic gains of IITA Breeding Scheme for their selection index to use as burn-in sim:
  
<br />

| logFYLD | HI  | DM  | MCMDS | logRTNO | logDYLD | logTOPYLD | PLTHT |
| :-----: | :-: | :-: | :---: | :-----: | :-----: | :-------: | :---: |
| 20x     | 10x | 15x | -10x  | 12x     | 20x     | 15x       | 10x   |
|         |     |     |       |         |         |           |       |
  
<br />  
  
  Marnin estimated the [genetic and error variances](https://wolfemd.github.io/IITA_2021GS/inputsForSimulationV2.html#Conclusions) for each trial type (CET, PYT, AYT, and UYT)
  
## IITA breeding Scheme
  
  
  
```{r message=FALSE, warning=FALSE}
library(tidyverse); library(reactable)
IITAScheme <- read.table(here::here("data", "baselineScheme - IITA.csv"),
                         sep = ";", dec = ".", header = T)
IITAScheme %>% reactable()
```

### Breeding Scheme Simulations parameters

  The burn-in simulation were replicated 20 times, simulating a 30 cycles of operations with the burn-in of the first 20 cycles.

<br />

| Sim Parameter       | Value  |     | Genetic Parameter | Value         |     | Variances Parameters  | Value |
| :-----------------: | :----: | :-: | :---------------: | :-----------: | :-: | :-------------------: | :---: |
| **nTrainPopCycles** | 10     |     | NChr              | 18            |     | **genVar**            | 1,500 |
| NYrsAsCandidates    | 2      |     | **effPopsize**    | 200           |     | gxeVar                | NULL  |
| maxTrainingPopSize  | 200    |     | segSites          | 30,000        |     | gxyVar                | 1,500 |
| stageToGenotype     | CET    |     | **nQTL**          | 1x to 5x nSNP |     | gxlVar                | 750   |
| nParents            | 100    |     | nSNP              | 500           |     | gxyxlVar              | 300   |
| nCrosses            | 250    |     |                   |               |     | meanDD                | 0.23  |
| nProgeny            | 10     |     |                   |               |     | varDD                 | 0.05  |
| nClonesToNCRP       | 3      |     |                   |               |     | relAA                 | 0.5   |
| phenoF1toStage1     | FALSE  |     |                   |               |     | errVarPreStage1       | 4,000 |
|                     |        |     |                   |               |     |                       |       |
  
<br />  

  For this purpose we need to decide the priori for the following parameters of the IITA burn-in sim:
  
  a. **Ne** - Effective Population Size;
  b. **nQTL** - Number of Quantitative Trait Loci;
  c. **genVar** - Genetic variance;
  d. **trainingPopCycles** - Number of Cycles each clone is used as Training Population.

  To estimate the best scenario, I will use the parameters defined as the table above, and create at least five scenarios for Ne, nQTL, genVar, and trainingPopCycles parameters.

#### **Ne** - Effective Population Size

  Marnin made some simulations testing three different **Ne**, *100*, *200*, and *1000*.

  We choose an Effective Population Size of **200**.

[Marnin Results](https://wolfemd.github.io/BreedingSchemeOpt/burnInSims.html#Run_full-scale_burn-in_sims)


#### **nQTL** - Number of Quantitative Trait Loci

The simulation for est

<br />

| NÂ°  | nSNP | nQTL  | nQTL/nSNP | check |
| :-: | :--: | :---: | :-------: | :---: |
| 1   | 500  | 500   | 1.0x      | [x]   |
| 2   | 500  | 750   | 1.5x      | [x]   |
| 3   | 500  | 1,000 | 2.0x      | [ ]   |
| 4   | 500  | 1,250 | 2.5x      | [ ]   |
| 5   | 500  | 1,500 | 3.0x      | [ ]   |
| 6   | 500  | 1,750 | 3.5x      | [ ]   |
| 7   | 500  | 2,000 | 4.0x      | [ ]   |
| 8   | 500  | 2,250 | 4.5x      | [ ]   |
| 9   | 500  | 2,500 | 5.0x      | [ ]   |
|     |      |       |           |       |

<br/>

```{r, eval = F}
suppressMessages(library(AlphaSimHlpR))
suppressMessages(library(tidyverse))
suppressMessages(library(genomicMateSelectR))
library(dplyr); library(furrr); library(here)
select <- dplyr::select
schemeDF <- read.csv(here::here("data","baselineScheme - IITA.csv"), 
                     header = T, stringsAsFactors = F, sep = ";")

bsp1 <- specifyBSP(schemeDF = schemeDF,
                   nTrainPopCycles = 10, nYrsAsCandidates = 2, maxTrainingPopSize = 200,
                   nChr = 10, effPopSize = 200, quickHaplo = F,
                   segSites = 1500, nQTL = 1000, nSNP = 500, genVar = 1500,
                   gxeVar = NULL, gxyVar = 1500, gxlVar = 750, gxyxlVar = 300,
                   meanDD = 0.23, varDD = 0.06, relAA = 0.5,
                   stageToGenotype = "CET",
                   nParents = 100, nCrosses = 250, nProgeny = 10, nClonesToNCRP = 3,
                   phenoF1toStage1 = T, errVarPreStage1 = 17500,
                   useCurrentPhenoTrain = F,
                   nCyclesToKeepRecords = 4,
                   selCritPipeAdv = selCritIID,
                   selCritPopImprov =  selCritIID)

bsp2 <- specifyBSP(schemeDF = schemeDF,
                   nTrainPopCycles = 10, nYrsAsCandidates = 2, maxTrainingPopSize = 200,
                   nChr = 10, effPopSize = 200, quickHaplo = F,
                   segSites = 1500, nQTL = 1000, nSNP = 500, genVar = 1500,
                   gxeVar = NULL, gxyVar = 1500, gxlVar = 750, gxyxlVar = 300,
                   meanDD = 0.23, varDD = 0.06, relAA = 0.5,
                   stageToGenotype = "CET",
                   nParents = 100, nCrosses = 250, nProgeny = 10, nClonesToNCRP = 3,
                   phenoF1toStage1 = T, errVarPreStage1 = 17500,
                   useCurrentPhenoTrain = F,
                   nCyclesToKeepRecords = 4,
                   selCritPipeAdv = selCritIID,
                   selCritPopImprov =  selCritIID)

bsp3 <- specifyBSP(schemeDF = schemeDF,
                   nTrainPopCycles = 10, nYrsAsCandidates = 2, maxTrainingPopSize = 200,
                   nChr = 10, effPopSize = 200, quickHaplo = F,
                   segSites = 1500, nQTL = 1000, nSNP = 500, genVar = 1500,
                   gxeVar = NULL, gxyVar = 1500, gxlVar = 750, gxyxlVar = 300,
                   meanDD = 0.23, varDD = 0.06, relAA = 0.5,
                   stageToGenotype = "CET",
                   nParents = 100, nCrosses = 250, nProgeny = 10, nClonesToNCRP = 3,
                   phenoF1toStage1 = T, errVarPreStage1 = 17500,
                   useCurrentPhenoTrain = F,
                   nCyclesToKeepRecords = 4,
                   selCritPipeAdv = selCritIID,
                   selCritPopImprov =  selCritIID)
source(here::here("code","runBurnInSchemes.R"))
```

```{r, eval = FALSE}
set.seed(501)
set.seed(501)
start <- proc.time()[3]
burnIn_1 <- runBurnInSchemes(bsp = bsp1,
                    	         nBurnInCycles=20,
                           	 selCritPop="selCritIID",
                         	 selCritPipe="selCritIID",
                         	 iniFunc="initializeScheme",
                        	 productFunc="productPipeline",
                      		 popImprovFunc="popImprov1Cyc",
            	                 nReplications=20,ncores=1,
                              	 nBLASthreads=1,nThreadsMacs2=1)
end <- proc.time()[3]; print(paste0(floor((end - start)/60), "mins ", floor(((end - start)%%60)), "s elapsed - bsp1"))
saveRDS(burnIn_1,file = here::here("output","BurnInGS_test_nQTL1.rds"))
rm(burnIn_1); rm(bsp1); rm(start); rm(end)


```


```{r, eval = F}
suppressMessages(library(AlphaSimHlpR))
suppressMessages(library(tidyverse))
suppressMessages(library(genomicMateSelectR))
select <- dplyr::select

forSimPlot<-tibble(bsp="1",nQTL=500) %>%
  bind_rows(tibble(bsp="2",nQTL=750)) %>%
  mutate(sims=paste0("BurnInGS_nQTL",bsp,".rds"),
         sims=map(sims,~readRDS(here::here("output",.))))
forSimPlot %<>% 
  mutate(sims=map(sims,function(sims){ 
  sims %>% 
      mutate(burnInSim=map(burnInSim,~.$records$stageOutputs)) })) %>% 
  unnest(sims) %>% 
  unnest(burnInSim) %>% 
  filter(stage=="F1") %>% 
  mutate(Year=year-max(year))
gc()
```

```{r, fig.width=10}
suppressMessages(library(AlphaSimHlpR))
suppressMessages(library(tidyverse))
suppressMessages(library(genomicMateSelectR))
suppressMessages(library(here))
select <- dplyr::select
mutate <- dplyr::mutate

forSimPlot <- readRDS(here::here("output", "forSimPlot.rds"))
forSimPlot %<>% 
  mutate(Pop = paste0("nQTL",nQTL))
library(patchwork)
meanGplot<-forSimPlot %>% 
  group_by(Pop,nQTL,Year,year,stage) %>% 
  summarize(meanGenMean=mean(genValMean),
            seGenMean=sd(genValMean)/n()) %>% ungroup() %>% 
  ggplot(.,aes(x=Year,group=Pop)) +
  geom_ribbon(aes(ymin = meanGenMean - seGenMean, 
                  ymax = meanGenMean + seGenMean,
                  fill=Pop), 
              alpha=0.75) + 
  geom_line(aes(y = meanGenMean, color=Pop))
sdGplot<-forSimPlot %>% 
  group_by(Pop,nQTL,Year,year,stage) %>% 
  summarize(meanGenSD=mean(genValSD),
            seGenSD=sd(genValSD)/n()) %>% ungroup() %>% 
  ggplot(.,aes(x=Year,group=Pop)) +
  geom_ribbon(aes(ymin = meanGenSD - seGenSD, 
                  ymax = meanGenSD + seGenSD,
                  fill=Pop), 
              alpha=0.75) + 
  geom_line(aes(y = meanGenSD))
(meanGplot | sdGplot) & theme_bw()
```
