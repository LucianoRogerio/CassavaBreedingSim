---
title: "Variety Development Process Optimization"
author: "Wolfemd, LucianoRogerio"
date: "2021-09-16"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

  We are simulating the expected genetic gains of IITA Breeding Scheme for their selection index to use as burn-in sim:
  
<br />

| logFYLD | HI  | DM  | MCMDS | logRTNO | logDYLD | logTOPYLD | PLTHT |
| :-----: | :-: | :-: | :---: | :-----: | :-----: | :-------: | :---: |
| 20x     | 10x | 15x | -10x  | 12x     | 20x     | 15x       | 10x   |
|         |     |     |       |         |         |           |       |
  
<br />  
  
  Marnin estimated the [genetic and error variances](https://wolfemd.github.io/IITA_2021GS/inputsForSimulationV2.html#Conclusions) for each trial type (CET, PYT, AYT, and UYT)
  
## IITA breeding Scheme 1
  
  
  
```{r message=FALSE, warning=FALSE}
library(tidyverse); library(reactable)
IITAScheme <- read.table(here::here("data", "baselineScheme - IITA.csv"),
                         sep = ";", dec = ".", header = T)
IITAScheme %>% reactable()
```

### Breeding Scheme Simulations parameters

  The burn-in simulation were replicated 20 times, simulating a 30 cycles of operations with the burn-in of the first 20 cycles.

<br />

| Sim Parameter       | Value  |     | Genetic Parameter | Value  |     | Variances Parameters  | Value  |
| :-----------------: | :----: | :-: | :---------------: | :----: | :-: | :-------------------: | :----: |
| **nTrainPopCycles** | 10     |     | **NChr**          | 10     |     | **genVar**            | 750    |
| NYrsAsCandidates    | 2      |     | **effPopsize**    | 200    |     | gxeVar                | NULL   |
| maxTrainingPopSize  | 200    |     | **segSites**      | 1,500  |     | **gxyVar**            | 100    |
| stageToGenotype     | CET    |     | **nQTL**          | 1,000  |     | gxlVar                | 500    |
| nParents            | 100    |     | **nSNP**          | 500    |     | **gxyxlVar**          | 300    |
| nCrosses            | 250    |     |                   |        |     | meanDD                | 0.23   |
| nProgeny            | 10     |     |                   |        |     | varDD                 | 0.05   |
| nClonesToNCRP       | 3      |     |                   |        |     | relAA                 | 0.5    |
| **phenoF1toStage1** | TRUE   |     |                   |        |     | **errVarPreStage1**   | 15,000 |
|                     |        |     |                   |        |     |                       |        |
  
<br />  




```{r, eval = F}
suppressMessages(library(AlphaSimHlpR))
suppressMessages(library(tidyverse))
suppressMessages(library(genomicMateSelectR))
select <- dplyr::select

forSimPlot<-tibble(bsp="1",nQTL=500) %>%
  bind_rows(tibble(bsp="2",nQTL=750)) %>%
  mutate(sims=paste0("BurnInGS_nQTL",bsp,".rds"),
         sims=map(sims,~readRDS(here::here("output",.))))
forSimPlot %<>% 
  mutate(sims=map(sims,function(sims){ 
  sims %>% 
      mutate(burnInSim=map(burnInSim,~.$records$stageOutputs)) })) %>% 
  unnest(sims) %>% 
  unnest(burnInSim) %>% 
  filter(stage=="F1") %>% 
  mutate(Year=year-max(year))
gc()
```

```{r, fig.width=10}
suppressMessages(library(AlphaSimHlpR))
suppressMessages(library(tidyverse))
suppressMessages(library(genomicMateSelectR))
suppressMessages(library(here))
select <- dplyr::select
mutate <- dplyr::mutate

forSimPlot <- readRDS(here::here("output", "forSimPlot.rds"))
forSimPlot %<>% 
  mutate(Pop = paste0("nQTL",nQTL))
library(patchwork)
meanGplot<-forSimPlot %>% 
  group_by(Pop,nQTL,Year,year,stage) %>% 
  summarize(meanGenMean=mean(genValMean),
            seGenMean=sd(genValMean)/n()) %>% ungroup() %>% 
  ggplot(.,aes(x=Year,group=Pop)) +
  geom_ribbon(aes(ymin = meanGenMean - seGenMean, 
                  ymax = meanGenMean + seGenMean,
                  fill=Pop), 
              alpha=0.75) + 
  geom_line(aes(y = meanGenMean, color=Pop))
sdGplot<-forSimPlot %>% 
  group_by(Pop,nQTL,Year,year,stage) %>% 
  summarize(meanGenSD=mean(genValSD),
            seGenSD=sd(genValSD)/n()) %>% ungroup() %>% 
  ggplot(.,aes(x=Year,group=Pop)) +
  geom_ribbon(aes(ymin = meanGenSD - seGenSD, 
                  ymax = meanGenSD + seGenSD,
                  fill=Pop), 
              alpha=0.75) + 
  geom_line(aes(y = meanGenSD))
(meanGplot | sdGplot) & theme_bw()
```
