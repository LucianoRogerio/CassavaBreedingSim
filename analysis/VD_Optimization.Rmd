---
title: "Variety Development Product Optimization"
author: "Wolfemd, LucianoRogerio"
date: "2021-09-16"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

  We are simulating the expected genetic gains of IITA Breeding Scheme for their selection index to use as burn-in sim:
  
<br />

| logFYLD | HI  | DM  | MCMDS | logRTNO | logDYLD | logTOPYLD | PLTHT |
| :-----: | :-: | :-: | :---: | :-----: | :-----: | :-------: | :---: |
| 20x     | 10x | 15x | -10x  | 12x     | 20x     | 15x       | 10x   |
|         |     |     |       |         |         |           |       |
  
<br />  
  
  Marnin estimated the [genetic and error variances](https://wolfemd.github.io/IITA_2021GS/inputsForSimulationV2.html#Conclusions) for each trial type (CET, PYT, AYT, and UYT)
  
## Prepare the Singularity Image to run the Simulations on BioHPC servers

The steps to create the singularity image with all the required packages are described at this [link](SingularityIm.html).
  

### Breeding Scheme Simulations parameters

  The burn-in simulation were replicated 20 times, simulating a 26 cycles of operations with the burn-in of the first 20 cycles.

<br />

| Sim Parameter      | Value  |     | Genetic Parameter | Value  |     | Variances Parameters | Value  |
| :----------------: | :----: | :-: | :---------------: | :----: | :-: | :------------------: | :----: |
| nTrainPopCycles    | 3      |     | NChr              | 18     |     | genVar               | 1,500  |
| NYrsAsCandidates   | 3      |     | effPopsize        | 200    |     | gxeVar               | NULL   |
| maxTrainingPopSize | 1000   |     | segSites          | 1,650  |     | gxyVar               | 1,500  |
| stageToGenotype    | CET    |     | nQTL              | 1,000  |     | gxlVar               | 750    |
| nParents           | 100    |     | nSNP              | 500    |     | gxyxlVar             | 300    |
| nCrosses           | 400    |     |                   |        |     | meanDD               | 0.25   |
| nProgeny           | 25     |     |                   |        |     | varDD                | 0.05   |
| nClonesToNCRP      | 3      |     |                   |        |     | relAA                | 0.5    |
| phenoF1toStage1    | FALSE  |     |                   |        |     | errVarPreStage1      | 17,500 |
|                    |        |     |                   |        |     |                      |        |
  
<br />  

## Breeding Schemes scenarios

### IITA breeding Scheme
```{r message=FALSE, warning=FALSE}
library(tidyverse); library(reactable)
IITAScheme <- read.table(here::here("data", "baselineScheme - IITA.csv"),
                         sep = ";", dec = ".", header = T)
IITAScheme %>% reactable()
```

Simulations for IITA [breeding Scheme](IITABS.html)

### IITA 1ยบ alternative breeding Scheme (Five years VDP)
```{r message=FALSE, warning=FALSE}
library(tidyverse); library(reactable)
IITAScheme <- read.table(here::here("data", "baselineScheme - IITA - NVDP1.csv"),
                         sep = ";", dec = ".", header = T)
IITAScheme %>% reactable()
```

Simulations for IITA [1ยบ alternative breeding Scheme](NVDP1.html) (Five years VDP)

### IITA breeding Scheme 2ยบ alternative (Four years VDP)
```{r message=FALSE, warning=FALSE}
library(tidyverse); library(reactable)
IITAScheme <- read.table(here::here("data", "baselineScheme - IITA - NVDP2.csv"),
                         sep = ";", dec = ".", header = T)
IITAScheme %>% reactable()
```

Simulations for IITA [2ยบ alternative breeding Scheme](NVDP2.html) (Four years VDP)




### Simulations of IITA Breeding Scheme with clones selected as parent from different years as candidate

Scripts at this [link](1-3YrsIITABS.html)




## Simulation Results

This Results reduced so drastically the GS accuracy, due to the reduction of the G matrix size.
The next simulation results were obtained with a G matrix of 4,882 clones.
While the Results of the simulations increasing the number of years [as candidate](#BreedingScheme1-3) have:

| YrsAsCand | G size |
| :-------: | :----: |
| 1         | 3,502  |
| 2         | 6,002  |
| 3         | 8,502  |
|           |        |

#### Parents Figure

##### Figure 1
```{r Figure 1 Parents IITA Breeding Scheme, fig.width=10, echo = FALSE, message = FALSE, warning = FALSE}
library(here); suppressMessages(library(tidyverse)); library(ggpubr)

forSimPlot <- readRDS(here::here("output", "DataSimPlotIITA_Par.rds"))

meanGplot1 <- forSimPlot %>% mutate(YearPostBurnIn = Year - 20) %>%
              filter(YearPostBurnIn >= -3) %>%
              group_by(PostBurnIn, YearPostBurnIn, Year) %>% 
              summarize(meanGenMean = mean(genoValMean),
              seGenMean = sd(genoValMean) / sqrt(n())) %>% 
              ggplot(., aes(x = YearPostBurnIn)) +
              geom_ribbon(aes(ymin = meanGenMean - seGenMean, 
                              ymax = meanGenMean + seGenMean,
                              fill = PostBurnIn), alpha = 0.25) + 
              geom_line(aes(y = meanGenMean, color = PostBurnIn)) + 
              theme_minimal()

sdGplot1 <- forSimPlot %>% mutate(YearPostBurnIn = Year - 20) %>%
            filter(YearPostBurnIn >= -3) %>%
            group_by(PostBurnIn, YearPostBurnIn, Year) %>% 
            summarize(meanGenSD = mean(genValSD),
                      seGenSD = sd(genValSD) / sqrt(n())) %>% 
            ggplot(., aes(x = YearPostBurnIn)) +
            geom_ribbon(aes(ymin = meanGenSD - seGenSD, 
                            ymax = meanGenSD + seGenSD,
                            fill = PostBurnIn), alpha = 0.25) + 
            geom_line(aes(y = meanGenSD, color = PostBurnIn)) + 
            theme_minimal()

ggarrange(meanGplot1, sdGplot1, common.legend = TRUE, legend = "right")
```


##### Figure 2
```{r Figure 2 Parents IITA Breeding Scheme, fig.width=10, echo = FALSE, message = FALSE, warning = FALSE}
meanGplot2 <- forSimPlot %>% mutate(YearPostBurnIn = Year - 20) %>%
              filter(YearPostBurnIn >= -3) %>%
              group_by(PostBurnIn, YearPostBurnIn, Year) %>% 
              ggplot(., aes(x = YearPostBurnIn, y = genoValMean)) +
              geom_smooth(method = "loess", alpha = 0.25,
                          aes(color = PostBurnIn)) + 
              theme_minimal()

sdGplot2 <- forSimPlot %>% mutate(YearPostBurnIn = Year - 20) %>%
            filter(YearPostBurnIn >= -3) %>%
            group_by(PostBurnIn, YearPostBurnIn, Year) %>% 
            ggplot(., aes(x = YearPostBurnIn, y = genValSD)) +
            geom_smooth(method = "loess", alpha = 0.25,
                        aes(color = PostBurnIn)) + 
            theme_minimal()

ggarrange(meanGplot2, sdGplot2, common.legend = TRUE, legend = "right")
```

##### Genomic Prediction Accuracy for the Candidates

```{r Accuracies, echo = FALSE, message = FALSE, warning = FALSE}

Accuracyplot2 <- forSimPlot %>% mutate(YearPostBurnIn = Year - 20) %>%
              filter(YearPostBurnIn >= -3) %>%
              group_by(PostBurnIn, YearPostBurnIn, Year) %>% 
              ggplot(., aes(x = YearPostBurnIn, y = accAtSel)) +
              geom_smooth(method = "loess", alpha = 0.25,
                          aes(color = PostBurnIn)) + 
              theme_minimal()

Neplot2 <- forSimPlot %>% mutate(YearPostBurnIn = Year - 20) %>%
              filter(YearPostBurnIn >= -3) %>%
              group_by(PostBurnIn, YearPostBurnIn, Year) %>% 
              ggplot(., aes(x = YearPostBurnIn, y = NeCan)) +
              geom_smooth(method = "loess", alpha = 0.25,
                          aes(color = PostBurnIn)) + 
              theme_minimal()

ggarrange(Accuracyplot2, Neplot2, common.legend = TRUE, legend = "right")
```

#### Origin of the parents in each year

```{r Origin Parents, eval = FALSE, message = FALSE, warning = FALSE}
IITA_F1s <- readRDS(here::here("output", "ParentOriginGS.rds")) %>%
  select(Replicate, YearProgeny, ParentsDt) %>% unique %>%
  unnest(ParentsDt) %>% filter((!is.na(Year) | !is.na(gv)) & YearProgeny != 20)

IITA_F1s %>% mutate(YearProgeny = as.factor(YearProgeny)) %>%
  ggplot( aes(x = YearProgeny, y=gv)) +
  geom_boxplot() +
  scale_fill_viridis(discrete = TRUE, alpha=0.6) +
  geom_jitter(aes(color=Stage), size=0.4, alpha=0.9) +
  theme_ipsum()

```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
PO <- read.table(file = here::here("output", "ParentOriginGS.csv"), sep = ",", header = T) %>%
  filter(YearProgeny != 20) %>% filter(!is.na(StageParents))
PO$StageParents <- factor(PO$StageParents, levels = c("CET", "PYT", "AYT", "UYT1", "UYT2"))


PO %>% ggplot(aes(x = YearProgeny, fill = StageParents, y = NumberParents)) +
  geom_bar(position = "fill", stat = "identity") + xlab("Year") + ylab("Percentage (%)") +
  scale_x_continuous(breaks = seq(21,31,1))

```


#### F1

##### Figure 1
```{r Figure 1 F1 IITA Breeding Scheme, fig.width=10, echo = FALSE, message = FALSE, warning = FALSE}
library(here); suppressMessages(library(tidyverse)); library(ggpubr)

forSimPlot <- readRDS(here::here("output", "DataSimPlotIITA_F1.rds"))

meanGplot1 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
              group_by(PostBurnIn, YearPostBurnIn, year) %>% 
              summarize(meanGenMean = mean(genValMean),
              seGenMean = sd(genValMean) / sqrt(n())) %>% 
              ggplot(., aes(x = YearPostBurnIn)) +
              geom_ribbon(aes(ymin = meanGenMean - seGenMean, 
                              ymax = meanGenMean + seGenMean,
                              fill = PostBurnIn), alpha = 0.25) + 
              geom_line(aes(y = meanGenMean, color = PostBurnIn)) + 
              theme_minimal()

sdGplot1 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
            group_by(PostBurnIn, YearPostBurnIn, year) %>% 
            summarize(meanGenSD = mean(genValSD),
                      seGenSD = sd(genValSD) / sqrt(n())) %>% 
            ggplot(., aes(x = YearPostBurnIn)) +
            geom_ribbon(aes(ymin = meanGenSD - seGenSD, 
                            ymax = meanGenSD + seGenSD,
                            fill = PostBurnIn), alpha = 0.25) + 
            geom_line(aes(y = meanGenSD, color = PostBurnIn)) + 
            theme_minimal()

ggarrange(meanGplot1, sdGplot1, common.legend = TRUE, legend = "right")
```


##### Figure 2
```{r Figure 2 F1 IITA Breeding Scheme, fig.width=10, echo = FALSE, message = FALSE, warning = FALSE}

meanGplot2 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
              group_by(PostBurnIn, YearPostBurnIn, year) %>% 
              ggplot(., aes(x = YearPostBurnIn, y = genValMean)) +
              geom_smooth(method = "loess", alpha = 0.25,
                          aes(color = PostBurnIn)) + 
              theme_minimal()

sdGplot2 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
            group_by(PostBurnIn, YearPostBurnIn, year, stage) %>% 
            ggplot(., aes(x = YearPostBurnIn, y = genValSD)) +
            geom_smooth(method = "loess", alpha = 0.25,
                        aes(color = PostBurnIn)) + 
            theme_minimal()

ggarrange(meanGplot2, sdGplot2, common.legend = TRUE, legend = "right")
```


### Last Stages

#### Figure 1
```{r Figure 1 UYT2 IITA Breeding Scheme, fig.width=10, echo = FALSE, message = FALSE, warning = FALSE}
library(here); suppressMessages(library(tidyverse)); library(ggpubr)

forSimPlot <- readRDS(here::here("output", "DataSimPlotIITA_UYT2.rds"))

meanGplot1 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
              group_by(PostBurnIn, YearPostBurnIn, year) %>% 
              summarize(meanGenMean = mean(genValMean),
              seGenMean = sd(genValMean) / sqrt(n())) %>% 
              ggplot(., aes(x = YearPostBurnIn)) +
              geom_ribbon(aes(ymin = meanGenMean - seGenMean, 
                              ymax = meanGenMean + seGenMean,
                              fill = PostBurnIn), alpha = 0.25) + 
              geom_line(aes(y = meanGenMean, color = PostBurnIn)) + 
              theme_minimal()

sdGplot1 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
            group_by(PostBurnIn, YearPostBurnIn, year) %>% 
            summarize(meanGenSD = mean(genValSD),
                      seGenSD = sd(genValSD) / sqrt(n())) %>% 
            ggplot(., aes(x = YearPostBurnIn)) +
            geom_ribbon(aes(ymin = meanGenSD - seGenSD, 
                            ymax = meanGenSD + seGenSD,
                            fill = PostBurnIn), alpha = 0.25) + 
            geom_line(aes(y = meanGenSD, color = PostBurnIn)) + 
            theme_minimal()

ggarrange(meanGplot1, sdGplot1, common.legend = TRUE, legend = "right")
```


##### Figure 2
```{r Figure 2 UYT2 IITA Breeding Scheme, fig.width=10, echo = FALSE, message = FALSE, warning = FALSE}

meanGplot2 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
              group_by(PostBurnIn, YearPostBurnIn, year) %>% 
              ggplot(., aes(x = YearPostBurnIn, y = genValMean)) +
              geom_smooth(method = "loess", alpha = 0.25,
                          aes(color = PostBurnIn)) + 
              theme_minimal()

sdGplot2 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
            group_by(PostBurnIn, YearPostBurnIn, year, stage) %>% 
            ggplot(., aes(x = YearPostBurnIn, y = genValSD)) +
            geom_smooth(method = "loess", alpha = 0.25,
                        aes(color = PostBurnIn)) + 
            theme_minimal()

ggarrange(meanGplot2, sdGplot2, common.legend = TRUE, legend = "right")
```


<div id="BreedingScheme1-3" />

### Simulations IITA Breeding Scheme - 1-3 Years as Candidate

#### Figure 1

```{r, fig.width=10, echo = FALSE, message = FALSE, warning = FALSE}
library(here); suppressMessages(library(tidyverse)); library(ggpubr)

forSimPlot <- readRDS(here::here("output", "DataSimPlotIITA1_3_F1.rds"))


meanGplot1 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
              mutate(YearAsCand = as.factor(YearAsCand)) %>%
              group_by(YearAsCand, YearPostBurnIn, year) %>% 
              summarize(meanGenMean = mean(genValMean),
              seGenMean = sd(genValMean) / sqrt(n())) %>% 
              ggplot(., aes(x = YearPostBurnIn)) +
              geom_ribbon(aes(ymin = meanGenMean - seGenMean, 
                              ymax = meanGenMean + seGenMean,
                              fill = YearAsCand), alpha = 0.25) + 
              geom_line(aes(y = meanGenMean, color = YearAsCand)) + 
              theme_minimal()

sdGplot1 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
            mutate(YearAsCand = as.factor(YearAsCand)) %>%
            group_by(YearAsCand, YearPostBurnIn, year) %>% 
            summarize(meanGenSD = mean(genValSD),
                      seGenSD = sd(genValSD) / sqrt(n())) %>% 
            ggplot(., aes(x = YearPostBurnIn)) +
            geom_ribbon(aes(ymin = meanGenSD - seGenSD, 
                            ymax = meanGenSD + seGenSD,
                            fill = YearAsCand), alpha = 0.25) + 
            geom_line(aes(y = meanGenSD, color = YearAsCand)) + 
            theme_minimal()

ggarrange(meanGplot1, sdGplot1, common.legend = TRUE, legend = "right")
```

```{r smooth graph F1, echo = FALSE}
library(here); suppressMessages(library(tidyverse)); library(ggpubr)

forSimPlot <- readRDS(here::here("output", "DataSimPlotIITA1_3_F1.rds"))
meanGplot2 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
  mutate(YearAsCand = as.factor(YearAsCand)) %>%
  group_by(YearAsCand, YearPostBurnIn, year) %>% 
  ggplot(., aes(x = YearPostBurnIn, y = genValMean)) +
  geom_smooth(method = "loess", alpha = 0.25,
              aes(color = YearAsCand)) + 
  theme_minimal()

sdGplot2 <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
  mutate(YearAsCand = as.factor(YearAsCand)) %>%
  group_by(YearAsCand, YearPostBurnIn, year) %>%
  ggplot(., aes(x = YearPostBurnIn, y = genValSD)) +
  geom_smooth(method = "loess", alpha = 0.25,
              aes(color = YearAsCand)) + 
  theme_minimal()

ggarrange(meanGplot2, sdGplot2, common.legend = TRUE, legend = "right")
```

#### Figure UYT2
```{r, fig.width=10, echo = FALSE, message = FALSE, warning = FALSE}
library(here); suppressMessages(library(tidyverse)); library(ggpubr)

forSimPlot <- readRDS(here::here("output", "DataSimPlotIITA1_3_UYT2.rds"))

meanGplot <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
  mutate(YearAsCand = as.factor(YearAsCand)) %>%
  group_by(YearAsCand, YearPostBurnIn, year) %>% 
  ggplot(., aes(x = YearPostBurnIn, y = genValMean)) +
  geom_smooth(method = "loess", alpha = 0.25,
              aes(color = YearAsCand)) + 
  theme_minimal()

sdGplot <- forSimPlot %>% filter(YearPostBurnIn >= -3) %>%
  mutate(YearAsCand = as.factor(YearAsCand)) %>%
  group_by(YearAsCand, YearPostBurnIn, year) %>%
  ggplot(., aes(x = YearPostBurnIn, y = genValSD)) +
  geom_smooth(method = "loess", alpha = 0.25,
              aes(color = YearAsCand)) + 
  theme_minimal()

ggarrange(meanGplot, sdGplot, common.legend = TRUE, legend = "right")
```


#### Origin of the parents in each year - 3 years as Candidate

```{r Origin Parents 3 Yrs, echo = FALSE, message = FALSE, warning = FALSE}
PO <- read.table(file = here::here("output", "ParentOrigin3Yrs.csv"), sep = ",", header = T)
PO$StageParents <- factor(PO$StageParents, levels = c("CET", "PYT", "AYT"))


PO %>% ggplot(aes(x = YearProgeny, fill = StageParents, y = NumberParents)) +
  geom_bar(position = "fill", stat = "identity") + xlab("Year") + ylab("Percentage (%)") +
  scale_x_continuous(breaks = seq(21,31,1))

```


#### Origin of the parents in each year - 2 years as Candidate

```{r Origin Parents 2 Yrs, echo = FALSE, message = FALSE, warning = FALSE}
PO <- read.table(file = here::here("output", "ParentOrigin2Yrs.csv"), sep = ",", header = T)
PO$StageParents <- factor(PO$StageParents, levels = c("CET", "PYT", "AYT"))


PO %>% ggplot(aes(x = YearProgeny, fill = StageParents, y = NumberParents)) +
  geom_bar(position = "fill", stat = "identity") + xlab("Year") + ylab("Percentage (%)") +
  scale_x_continuous(breaks = seq(21,31,1))

```
